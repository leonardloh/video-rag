# VSS PoC - Video Search and Summarization
# Docker Compose configuration for full stack deployment

services:
  # Milvus Vector Database (standalone mode with embedded etcd)
  milvus-standalone:
    image: milvusdb/milvus:v2.5.4
    container_name: vss-milvus
    environment:
      ETCD_USE_EMBED: "true"
      ETCD_DATA_DIR: /var/lib/milvus/etcd
      COMMON_STORAGETYPE: local
    ports:
      - "19530:19530"  # gRPC
      - "9091:9091"    # HTTP
    volumes:
      - milvus_data:/var/lib/milvus
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - vss-network

  # Neo4j Graph Database
  neo4j:
    image: neo4j:5.26.4
    container_name: vss-neo4j
    environment:
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD:-password}
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: apoc.*
      NEO4J_dbms_memory_heap_initial__size: 512m
      NEO4J_dbms_memory_heap_max__size: 1G
    ports:
      - "7474:7474"  # HTTP (Browser)
      - "7687:7687"  # Bolt
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7474"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - vss-network

  # VSS PoC Application
  vss-poc:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vss-poc
    environment:
      # Gemini API (required)
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      # Milvus connection
      MILVUS_HOST: milvus-standalone
      MILVUS_PORT: 19530
      # Neo4j connection
      NEO4J_HOST: neo4j
      NEO4J_BOLT_PORT: 7687
      NEO4J_USERNAME: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-password}
      # Processing settings
      CHUNK_DURATION: ${CHUNK_DURATION:-60}
      MAX_CONCURRENT_UPLOADS: ${MAX_CONCURRENT_UPLOADS:-3}
      ENABLE_CV_PIPELINE: ${ENABLE_CV_PIPELINE:-true}
      # RAG settings
      RAG_TOP_K: ${RAG_TOP_K:-5}
      RAG_BATCH_SIZE: ${RAG_BATCH_SIZE:-6}
      RETRIEVAL_MODE: ${RETRIEVAL_MODE:-hybrid}
      # YOLO settings
      YOLO_MODEL: ${YOLO_MODEL:-yolov8n-seg}
      YOLO_CONFIDENCE: ${YOLO_CONFIDENCE:-0.5}
      YOLO_DEVICE: ${YOLO_DEVICE:-cpu}
    ports:
      - "7860:7860"  # Gradio UI
    volumes:
      - ./videos:/app/videos
      - ./output:/app/output
      - vss_temp:/app/temp
    depends_on:
      milvus-standalone:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    networks:
      - vss-network
    restart: unless-stopped

  # VSS PoC CLI (for one-off video processing)
  # Usage: docker-compose run --rm vss-cli --video /app/videos/video.mp4 --summarize
  vss-cli:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vss-cli
    environment:
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      MILVUS_HOST: milvus-standalone
      MILVUS_PORT: 19530
      NEO4J_HOST: neo4j
      NEO4J_BOLT_PORT: 7687
      NEO4J_USERNAME: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-password}
      YOLO_DEVICE: ${YOLO_DEVICE:-cpu}
    volumes:
      - ./videos:/app/videos
      - ./output:/app/output
      - vss_temp:/app/temp
    entrypoint: ["python", "run_poc.py"]
    profiles:
      - cli
    depends_on:
      milvus-standalone:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    networks:
      - vss-network

volumes:
  milvus_data:
    driver: local
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  vss_temp:
    driver: local

networks:
  vss-network:
    driver: bridge
